{% extends "base.html" %}

{% block button %}
  <a class="px-6 py-2 bg-primary/10 text-primary dark:bg-primary/20 dark:text-primary rounded-full font-semibold hover:bg-primary/20 dark:hover:bg-primary/30 transition-colors duration-200" href="/">Logout</a>
{% endblock %}

{% block content %}
    <div class="w-full max-w-lg bg-white dark:bg-[#063b20] rounded-2xl shadow-lg p-8 space-y-6 text-center">
      <h2 class="text-3xl font-bold text-gray-900 dark:text-white">üí≥ Payment</h2>
      <p class="text-gray-500 dark:text-gray-300">Complete your payment securely before submitting your application</p>

      <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-6 text-left">
        <div class="flex justify-between mb-1">
          <span>Service Name</span>
          <span>{{ service.title }}</span>
        </div>
        <div class="flex justify-between mb-1">
          <span>Application Fee</span>
          <span>‚Çπ{{ service.base_price }}</span>
        </div>
        <hr class="my-2">
        <div class="flex justify-between font-bold text-lg">
          <span>Total</span>
          <span>‚Çπ{{ service.base_price }}</span>
        </div>
      </div>

      <!-- Razorpay Payment Button -->
      <button id="rzp-button1"
              class="bg-green-600 text-white py-3 px-8 rounded-full w-full hover:bg-green-700 transition-all duration-200">
        Pay with Razorpay
      </button>

      <!-- Submit After Payment -->
      <form action="/submit_application" method="POST" class="mt-4">
        <input type="hidden" name="mobile" value="{{ session['mobile'] }}">
        <input type="hidden" name="service_id" value="{{ service.id }}">
        <input type="hidden" name="name" value="{{ service.name }}">
        <input type="hidden" name="email" value="{{ service.email }}">
        <input type="hidden" name="service" value="{{ service.title }}">
        <button id="submit-btn" type="submit" 
                class="bg-blue-400 text-white py-3 px-8 rounded-full w-full cursor-not-allowed transition-all duration-200">
          Submit Application
        </button>
      </form>
    </div>
  </div>

  <!-- Razorpay Script -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script>
    const payBtn = document.getElementById("rzp-button1");

    function disablePayButton() {
      payBtn.disabled = true;
      payBtn.innerText = "Payment Completed";
      payBtn.classList.add("bg-gray-400", "cursor-not-allowed");
      payBtn.classList.remove("bg-green-600", "hover:bg-green-700");
    }

    document.getElementById('rzp-button1').onclick = async function(e) {
    e.preventDefault();
    
    // Step 1: Create order via backend
    const response = await fetch("/create_order", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ amount: {{ service.base_price|int * 100 }} })
    });

    const orderData = await response.json();

    // Step 2: Razorpay Checkout Options
    var options = {
        "key": "rzp_test_Rcq1OkhS35AWp9",
        "amount": orderData.amount,
        "currency": "INR",
        "name": "Krishi E-Government Services",
        "description": "Payment for {{ service.title }}",
        "order_id": orderData.id,
        "handler": function (response) {
            // Payment successful
            alert('‚úÖ Payment successful! You can now submit your application.');

            // Enable the submit button
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = false;
            submitBtn.classList.remove('cursor-not-allowed', 'bg-blue-400');
            submitBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            payBtn.disabled = true;
            payBtn.innerText = "Payment Completed";
            payBtn.classList.add("cursor-not-allowed", "bg-gray-400");
            payBtn.classList.remove("bg-green-600", "hover:bg-green-700");

            // Optionally store payment info in hidden inputs or localStorage
            localStorage.setItem('payment_status', 'success');
        },
        "theme": { "color": "#0f9d58" }
    };

    var rzp1 = new Razorpay(options);
    rzp1.open();

    // Step 3: Handle payment failure
    rzp1.on('payment.failed', function (response){
        alert('‚ùå Payment failed! Please try again.');
    });
  };

  // Optional: Disable form submission if payment not done
  document.querySelector('form').addEventListener('submit', function(e) {
    if (localStorage.getItem('payment_status') !== 'success') {
      e.preventDefault();
      alert('‚ö†Ô∏è Please complete the payment before submitting your application.');
    }
  });
  </script>

{% endblock %}
